name: Auto-generate ZIP on changes
on:
  push:
    branches: [ main, master ]
    paths:
      - 'FUENTES/**'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  create-zip:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Debug - Show current state
      run: |
        echo "🔍 DEBUG INFO:"
        echo "Rama actual: ${{ github.ref_name }}"
        echo "📁 Contenido de FUENTES:"
        ls -la FUENTES/ || echo "❌ FUENTES no existe"
        echo "📦 ZIP actual (si existe):"
        ls -la FUENTES.zip || echo "ℹ️ FUENTES.zip no existe aún"
        echo "🆔 Último commit:"
        git log -1 --oneline
    
    - name: Create ZIP file
      run: |
        echo "📦 Creando ZIP desde carpeta FUENTES..."
        cd FUENTES
        zip -r ../FUENTES.zip . -x "*.git*" "*.DS_Store*"
        cd ..
        echo "✅ ZIP creado exitosamente"
        ls -la FUENTES.zip
        echo "📊 Tamaño del ZIP:"
        du -h FUENTES.zip
    
    - name: Check git status
      run: |
        echo "🔄 Estado de Git:"
        git status
        echo "📋 Archivos modificados:"
        git diff --name-only
        echo "📋 Archivos staged:"
        git diff --staged --name-only
    
    - name: Force commit ZIP (for testing)
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        echo "🤖 Forzando commit del ZIP..."
        git add FUENTES.zip
        
        if git diff --staged --quiet; then
          echo "⚠️ No hay cambios para commitear"
        else
          git commit -m "🤖 Auto-update FUENTES.zip [skip ci]"
          git push origin ${{ github.ref_name }}
          echo "✅ ZIP actualizado y pusheado"
        fi
